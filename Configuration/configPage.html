<!DOCTYPE html>
<html lang="en">
<head>
    <title>Jellyfin Ratings</title>
</head>
<body>
    <div id="JellyfinRatingsPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button">
        <div data-role="content">
            <div class="content-primary">
                
                <h1>Jellyfin Ratings Settings</h1>
                
                <div class="inputContainer">
                    <label class="inputLabel" for="MdblistApiKeyInput" style="margin-bottom: 5px;">MDBList API Key</label>
                    <input id="MdblistApiKeyInput" type="text" class="emby-input" autocomplete="off" />
                    <div class="fieldDescription">
                        Enter your MDBList API Key here. (Click Save to apply changes)
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button id="btnSaveRatingsConfig" type="button" class="raised emby-button button-submit block">
                        <span>Save</span>
                    </button>
                </div>

            </div>
        </div>

        <script type="text/javascript">
            // Scoping via IIFE to avoid global variables
            (function() {
                var pluginId = '93A5D7C8-2F1E-4B0A-9C3D-5E7F1A2B4C6D';
                var pageId = '#JellyfinRatingsPage';

                // Function to load config
                function loadConfig(page) {
                    console.log('[RatingsPlugin] Loading configuration...');
                    Dashboard.showLoadingMsg();
                    
                    ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                        var key = config.MdblistApiKey || "";
                        console.log('[RatingsPlugin] Current key in DB:', key);
                        
                        var input = page.querySelector('#MdblistApiKeyInput');
                        if (input) {
                            input.value = key;
                            input.disabled = false; // Force enable
                            input.removeAttribute('readonly');
                        }
                        
                        Dashboard.hideLoadingMsg();
                    });
                }

                // Function to save config
                function saveConfig(page) {
                    console.log('[RatingsPlugin] Saving...');
                    Dashboard.showLoadingMsg();
                    
                    var input = page.querySelector('#MdblistApiKeyInput');
                    var newKey = input ? input.value : "";

                    ApiClient.getPluginConfiguration(pluginId).then(function (config) {
                        config.MdblistApiKey = newKey;
                        
                        ApiClient.updatePluginConfiguration(pluginId, config).then(function (result) {
                            console.log('[RatingsPlugin] Saved!');
                            Dashboard.processPluginConfigurationUpdateResult(result);
                        });
                    });
                }

                // Register Event Listeners
                // We look for the element directly since the script is executed inline
                var pageElement = document.querySelector(pageId);
                
                if (pageElement) {
                    // On page show
                    pageElement.addEventListener('pageshow', function() {
                        loadConfig(pageElement);
                    });

                    // On button click
                    var btn = pageElement.querySelector('#btnSaveRatingsConfig');
                    if (btn) {
                        btn.addEventListener('click', function() {
                            saveConfig(pageElement);
                        });
                    }
                } else {
                    console.error('[RatingsPlugin] Could not find page!');
                }
            })();
        </script>
    </div>
</body>
</html>
